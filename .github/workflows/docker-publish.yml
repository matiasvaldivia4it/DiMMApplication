name: Docker Build & Publish

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  # Cambia esto por tu usuario de Docker Hub si no usas secretos, 
  # pero RECOMIENDO usar secretos: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: frontend
            context: ./frontend
            image_name: diabetes-frontend
          - service: auth-service
            context: ./auth-service
            image_name: diabetes-auth
          - service: api-gateway
            context: ./api-gateway
            image_name: diabetes-api-gateway
          - service: food-recognition
            context: ./food-recognition-service
            image_name: diabetes-food-recognition
          - service: meal-tracking
            context: ./meal-tracking-service
            image_name: diabetes-meal-tracking
          - service: user-profile
            context: ./user-profile-service
            image_name: diabetes-user-profile
          - service: notification
            context: ./notification-service
            image_name: diabetes-notification
          - service: analytics
            context: ./analytics-service
            image_name: diabetes-analytics

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        # Solo intenta login si no es un PR, o si quieres probar builds en PRs tambi√©n.
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/${{ matrix.image_name }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha,prefix=sha-,format=short

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
